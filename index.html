<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nin Online - Tier List Maker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* EDITOR & TIERS */
        .tier-label {
            width: 80px; min-width: 80px; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.5rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            outline: none; cursor: text; word-break: break-all; text-align: center; line-height: 1.1;
        }
        .tier-content {
            flex-grow: 1; display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.5rem;
            min-height: 120px; background-color: #1a1a1a; align-items: flex-start;
        }
        .tier-controls {
            width: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-color: #2d2d2d; gap: 5px; padding: 5px 0;
        }
        
        /* CARD PADRÃO */
        .draggable-item {
            width: 80px; height: 110px; cursor: grab; transition: transform 0.1s;
            background-color: #333; border: 2px solid transparent; border-radius: 6px;
            position: relative; display: flex; flex-direction: column; justify-content: flex-end;
            overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.3); flex-shrink: 0;
        }
        .ninja-image {
            width: 100%; height: 100%; background-size: contain; background-repeat: no-repeat;
            background-position: center bottom; margin-bottom: 20px; image-rendering: pixelated;
        }
        .ninja-name {
            position: absolute; bottom: 0; left: 0; width: 100%; background-color: rgba(0,0,0,0.85);
            color: #fff; font-size: 10px; text-align: center; padding: 2px 0;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-top: 1px solid #444;
        }
        .draggable-item:hover { transform: scale(1.05); border-color: #fbbf24; z-index: 10; }
        .draggable-item:active { cursor: grabbing; }
        .static-item { cursor: default !important; }
        .static-item:hover { transform: none !important; border-color: transparent !important; }

        /* MINI GAME CARDS */
        .battle-card {
            width: 160px; height: 220px; cursor: pointer; transition: all 0.2s;
            background-color: #2a2a2a; border: 4px solid #444; border-radius: 12px;
            position: relative; overflow: hidden; display: flex; flex-direction: column;
        }
        .battle-card:hover { transform: scale(1.05); border-color: #fbbf24; box-shadow: 0 0 20px rgba(251, 191, 36, 0.3); }
        .battle-card .ninja-image { margin-bottom: 40px; } 
        .battle-card .ninja-name { font-size: 14px; padding: 8px 0; font-weight: bold; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #777; }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-black border-b border-gray-800 p-4 sticky top-0 z-40 shadow-md">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4 md:gap-0">
            <div class="flex items-center gap-4 w-full md:w-auto justify-between md:justify-start">
                <h1 class="text-xl md:text-2xl font-bold text-yellow-500 cursor-pointer flex items-center gap-2 truncate" onclick="navigateTo('home')">
                    <i class="fas fa-scroll"></i> <span class="hidden sm:inline">Nin Online - Tier List</span> <span class="sm:hidden">Nin Tier</span>
                </h1>
                
                <div class="flex gap-2 ml-4">
                    <button onclick="navigateTo('home')" class="bg-gray-800 hover:bg-gray-700 border border-gray-600 text-white px-3 py-1.5 rounded-lg font-bold transition text-sm flex items-center gap-2">
                        <i class="fas fa-home"></i> Início
                    </button>
                    <button onclick="openMiniGameSetup()" class="bg-purple-900 hover:bg-purple-700 border border-purple-600 text-white px-3 py-1.5 rounded-lg font-bold transition text-sm flex items-center gap-2 shadow-lg shadow-purple-900/20">
                        <i class="fas fa-gamepad"></i> Mini Game
                    </button>
                </div>
            </div>
            
            <div class="flex items-center gap-3 w-full md:w-auto justify-end">
                <button id="login-btn" onclick="openLoginModal()" class="text-gray-400 hover:text-white px-3 py-1.5 rounded-lg font-bold transition flex items-center gap-2 text-sm">
                    <i class="fas fa-lock"></i> Admin
                </button>
                
                <div id="admin-info" class="hidden flex items-center gap-2 bg-red-900 bg-opacity-30 px-3 py-1.5 rounded-lg border border-red-700">
                    <span class="text-xs font-bold text-red-300"><i class="fas fa-user-shield"></i> ADMIN</span>
                    <button onclick="logout()" class="text-gray-400 hover:text-white text-xs ml-2" title="Sair"><i class="fas fa-sign-out-alt"></i></button>
                </div>

                <div class="h-6 w-px bg-gray-700 mx-1"></div>

                <button onclick="openCategoryModal()" class="bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-1.5 rounded-lg font-bold transition flex items-center gap-2 text-sm shadow-lg shadow-yellow-900/20">
                    <i class="fas fa-plus"></i> <span class="hidden sm:inline">Criar Nova</span><span class="sm:hidden">Criar</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTAINER -->
    <div class="container mx-auto p-4 flex-grow flex flex-col relative">

        <!-- ================= TELA INICIAL (HOME) ================= -->
        <div id="home-screen" class="flex flex-col gap-6 animate-fade-in">
            <div class="bg-gradient-to-r from-gray-800 to-gray-900 p-8 rounded-xl border border-gray-700 shadow-2xl text-center">
                <h2 class="text-3xl font-bold text-white mb-2">Comunidade Nin Online</h2>
                <p class="text-gray-400 mb-6">Crie Tier Lists ou vote no melhor Ninja no Mini Game!</p>
                <div class="flex justify-center gap-4 flex-wrap">
                    <button onclick="openCategoryModal()" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-lg font-bold shadow-lg transform hover:scale-105 transition">
                        Criar Tier List
                    </button>
                    <button onclick="openMiniGameSetup()" class="bg-purple-600 hover:bg-purple-500 text-white px-8 py-3 rounded-lg font-bold shadow-lg transform hover:scale-105 transition">
                        Jogar Batalha 1v1
                    </button>
                </div>
            </div>

            <!-- Aviso Discord -->
            <div class="p-4 bg-gray-800 rounded-lg border border-gray-700 flex flex-col md:flex-row items-center justify-center text-center gap-2 text-sm text-gray-400 shadow-md">
                <i class="fab fa-discord text-indigo-400 text-xl"></i>
                <p>Quer adicionar um personagem ou mudar uma imagem?</p>
                <p class="text-gray-500 hidden md:block">|</p>
                <p>Envie o print com o <span class="text-white font-bold">nome exato</span> para <span class="text-yellow-500 font-bold">Auriosh</span> no Discord.</p>
            </div>

            <!-- Grid de Tier Lists -->
            <div id="community-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <div class="col-span-full text-center py-10 text-gray-500">
                    <i class="fas fa-circle-notch fa-spin text-2xl mb-2"></i><br>Carregando comunidade...
                </div>
            </div>
        </div>

        <!-- ================= TELA DO MINI GAME ================= -->
        <div id="minigame-screen" class="hidden flex-col gap-6 items-center animate-fade-in max-w-6xl mx-auto w-full">
            <div class="w-full bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-xl text-center relative">
                <button onclick="navigateTo('home')" class="absolute top-4 left-4 text-gray-400 hover:text-white"><i class="fas fa-arrow-left"></i> Voltar</button>
                
                <h2 class="text-3xl font-bold text-yellow-500 mb-2">Batalha <span id="game-category-title">Ninjas</span></h2>
                <p class="text-gray-400 mb-8">Quem é melhor? Clique no vencedor!</p>

                <div id="battle-error-msg" class="hidden text-red-400 text-lg font-bold mb-8">Não há imagens suficientes para batalhar nesta categoria.</div>

                <!-- Área de Batalha -->
                <div id="battle-area" class="flex flex-col md:flex-row items-center justify-center gap-8 md:gap-12 mb-8">
                    <!-- Lutador 1 -->
                    <div id="fighter-1" class="battle-card group" onclick="voteBattle(1)">
                        <div class="ninja-image"></div>
                        <div class="ninja-name">Carregando...</div>
                    </div>

                    <div class="flex flex-col items-center gap-2">
                        <div class="text-4xl font-black text-red-600 italic">VS</div>
                        <button onclick="skipBattle()" class="text-xs text-gray-500 hover:text-white border border-gray-600 px-3 py-1 rounded-full hover:bg-gray-700 transition">
                            <i class="fas fa-forward"></i> Pular
                        </button>
                    </div>

                    <!-- Lutador 2 -->
                    <div id="fighter-2" class="battle-card group" onclick="voteBattle(2)">
                        <div class="ninja-image"></div>
                        <div class="ninja-name">Carregando...</div>
                    </div>
                </div>
                
                <div id="battle-loading" class="hidden text-yellow-500 font-bold mb-4"><i class="fas fa-spinner fa-spin"></i> Processando...</div>
            </div>

            <!-- Ranking Mini Game -->
            <div class="w-full bg-gray-900 p-6 rounded-xl border border-gray-800">
                <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <i class="fas fa-trophy text-yellow-500"></i> Ranking Geral
                    </h3>
                    
                    <!-- SELETOR DE MÊS -->
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-400">Mês:</label>
                        <select id="month-selector" onchange="changeRankingMonth(this.value)" class="bg-gray-800 text-white border border-gray-600 rounded px-2 py-1 text-sm focus:border-yellow-500 outline-none">
                            <option value="">Carregando...</option>
                        </select>
                    </div>
                </div>
                
                <div class="overflow-x-auto max-h-[600px] overflow-y-auto rounded-lg border border-gray-700">
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="text-xs text-gray-200 uppercase bg-gray-800 sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-center w-12">#</th>
                                <th scope="col" class="px-6 py-3">Nome</th>
                                <th scope="col" class="px-6 py-3 text-center w-16 text-green-400" title="Vitórias">V</th>
                                <th scope="col" class="px-6 py-3 text-center w-16 text-red-400" title="Derrotas">D</th>
                                <th scope="col" class="px-6 py-3 text-center w-16 text-blue-400" title="Total Partidas">Total</th>
                                <th scope="col" class="px-6 py-3 text-center w-24 text-yellow-400" title="% Aproveitamento">% Win</th>
                                <th scope="col" class="px-6 py-3 text-left w-32" title="Quem mais venceu">Vítima Fav.</th>
                                <th scope="col" class="px-6 py-3 text-left w-32" title="Para quem mais perdeu">Nêmesis</th>
                            </tr>
                        </thead>
                        <tbody id="game-ranking-body">
                            <!-- Linhas inseridas via JS -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Footer Discord no MiniGame -->
                <div class="mt-6 text-center text-xs text-gray-600 border-t border-gray-800 pt-4">
                    <p>Faltou alguém? Mande print com nome para <span class="text-yellow-600">Auriosh</span> no Discord.</p>
                </div>
            </div>
        </div>

        <!-- ================= TELA DO EDITOR ================= -->
        <div id="editor-screen" class="hidden flex-col lg:flex-row gap-6 animate-fade-in">
            <!-- Coluna Esquerda: Board -->
            <div class="flex-grow space-y-4">
                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 shadow-lg">
                    <div class="flex flex-col md:flex-row gap-4 mb-4 items-end">
                        <div class="w-full md:w-5/12">
                            <label class="text-[10px] uppercase text-gray-400 font-bold ml-1 tracking-wider">Nome da Tier List</label>
                            <input type="text" id="tier-title" placeholder="Ex: Meta PvP" 
                                class="bg-gray-900 text-white text-lg font-bold px-4 py-2 rounded border border-gray-600 focus:border-yellow-500 outline-none w-full">
                        </div>
                        <div class="w-full md:w-5/12">
                            <label class="text-[10px] uppercase text-gray-400 font-bold ml-1 tracking-wider">Seu Nick (Criador)</label>
                            <input type="text" id="creator-name" placeholder="Ex: Auriosh" maxlength="15"
                                class="bg-gray-900 text-white text-lg px-4 py-2 rounded border border-gray-600 focus:border-yellow-500 outline-none w-full">
                        </div>
                        <div class="flex gap-2 w-full md:w-2/12 justify-end">
                             <button onclick="addTierRow()" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded font-bold transition h-[46px]" title="Adicionar Linha">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button onclick="saveTierList()" class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded font-bold transition flex items-center gap-2 h-[46px] w-full justify-center">
                                <i class="fas fa-save"></i> SALVAR
                            </button>
                         </div>
                    </div>
                    <div id="tier-board" class="border border-gray-600 rounded overflow-hidden bg-black"></div>
                </div>
            </div>

            <!-- Coluna Direita: Banco de Imagens -->
            <div class="w-full lg:w-80 flex-shrink-0">
                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 sticky top-24 h-[calc(100vh-120px)] flex flex-col">
                    <div class="flex justify-between items-center mb-2 flex-shrink-0">
                        <h3 class="text-lg font-bold text-gray-300"><i class="fas fa-images mr-1"></i> <span id="category-display">Imagens</span></h3>
                        <span id="loading-indicator" class="text-xs text-yellow-500 hidden"><i class="fas fa-sync fa-spin"></i> Carregando...</span>
                    </div>
                    <div id="image-bank" class="flex flex-wrap gap-2 p-2 bg-gray-900 rounded overflow-y-auto flex-grow content-start" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    <div id="error-message" class="text-red-400 text-xs p-2 hidden flex-shrink-0"></div>
                </div>
            </div>
        </div>

        <!-- ================= TELA DE VISUALIZAÇÃO ================= -->
        <div id="view-screen" class="hidden flex-col gap-6 animate-fade-in">
            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 shadow-lg flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-4 w-full md:w-auto">
                    <button onclick="navigateTo('home')" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-bold transition"><i class="fas fa-arrow-left"></i> Voltar</button>
                    <div>
                        <h2 id="view-title" class="text-2xl font-bold text-yellow-500 leading-tight">Título</h2>
                        <p class="text-sm text-gray-400">Criado por: <span id="view-creator" class="text-white font-bold">Nome</span></p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button id="view-delete-btn" onclick="deleteCurrentTierList()" class="hidden bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded-lg font-bold transition"><i class="fas fa-trash"></i> Excluir</button>
                    <button id="view-edit-btn" onclick="editCurrentTierList()" class="hidden bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-2 rounded-lg font-bold transition"><i class="fas fa-pencil-alt"></i> Editar</button>
                    <button onclick="downloadTierListImage()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold transition flex items-center gap-2 shadow-lg"><i class="fas fa-camera"></i> Baixar Imagem</button>
                </div>
            </div>
            <div class="bg-gray-900 rounded-xl border border-gray-700 shadow-2xl overflow-hidden flex justify-center p-4 md:p-8">
                 <div id="view-capture-area" class="w-full max-w-5xl bg-gray-900 p-4 rounded-lg">
                    <div id="view-content" class="border border-gray-700 rounded overflow-hidden bg-black"></div>
                    <div class="flex justify-between items-center mt-2 px-1 opacity-50">
                        <div class="text-gray-500 text-xs">Nin Online - Tier List Maker</div>
                        <div class="text-yellow-600 text-[10px] font-bold">https://aurioshlookin.github.io/tierlistninonline/</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- MODAL CATEGORIA (TIER LIST) -->
    <div id="category-modal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-xl max-w-lg w-full p-6 border border-gray-700 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white">Criar Tier List de:</h3>
                <button onclick="closeModals()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="startEditor('ninjas')" class="bg-gray-700 hover:bg-yellow-600 hover:text-black p-4 rounded-lg transition flex flex-col items-center gap-2 group"><i class="fas fa-user-ninja text-3xl text-yellow-500 group-hover:text-black"></i><span class="font-bold">Ninjas</span></button>
                <button onclick="startEditor('maestrias')" class="bg-gray-700 hover:bg-blue-600 hover:text-white p-4 rounded-lg transition flex flex-col items-center gap-2 group"><i class="fas fa-scroll text-3xl text-blue-400 group-hover:text-white"></i><span class="font-bold">Maestrias</span></button>
                <button onclick="startEditor('jutsus')" class="bg-gray-700 hover:bg-red-600 hover:text-white p-4 rounded-lg transition flex flex-col items-center gap-2 group"><i class="fas fa-fire text-3xl text-red-500 group-hover:text-white"></i><span class="font-bold">Jutsus</span></button>
                <button onclick="startEditor('armas')" class="bg-gray-700 hover:bg-gray-200 hover:text-black p-4 rounded-lg transition flex flex-col items-center gap-2 group"><i class="fas fa-gavel text-3xl text-gray-400 group-hover:text-black"></i><span class="font-bold">Armas</span></button>
            </div>
        </div>
    </div>

    <!-- MODAL CATEGORIA (MINI GAME) -->
    <div id="minigame-setup-modal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-xl max-w-lg w-full p-6 border border-purple-600 shadow-2xl border-t-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white">Jogar Batalha 1v1:</h3>
                <button onclick="closeModals()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="startMiniGame('ninjas')" class="bg-gray-700 hover:bg-yellow-600 hover:text-black p-4 rounded-lg transition flex flex-col items-center gap-2 group"><i class="fas fa-user-ninja text-3xl text-yellow-500 group-hover:text-black"></i><span class="font-bold">Ninjas</span></button>
                <button onclick="startMiniGame('maestrias')" class="bg-gray-700 hover:bg-blue-600 hover:text-white p-4 rounded-lg transition flex flex-col items-center gap-2 group"><i class="fas fa-scroll text-3xl text-blue-400 group-hover:text-white"></i><span class="font-bold">Maestrias</span></button>
                <button onclick="startMiniGame('jutsus')" class="bg-gray-700 hover:bg-red-600 hover:text-white p-4 rounded-lg transition flex flex-col items-center gap-2 group"><i class="fas fa-fire text-3xl text-red-500 group-hover:text-white"></i><span class="font-bold">Jutsus</span></button>
                <button onclick="startMiniGame('armas')" class="bg-gray-700 hover:bg-gray-200 hover:text-black p-4 rounded-lg transition flex flex-col items-center gap-2 group"><i class="fas fa-gavel text-3xl text-gray-400 group-hover:text-black"></i><span class="font-bold">Armas</span></button>
            </div>
        </div>
    </div>

    <!-- MODAL LOGIN ADMIN -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-95 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-xl max-w-sm w-full p-6 border border-gray-700 shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2"><i class="fas fa-user-shield text-red-500"></i> Login Admin</h3>
            <div class="space-y-3">
                <input type="email" id="admin-email" placeholder="Email do Admin" class="w-full bg-gray-900 border border-gray-600 rounded p-3 text-white focus:border-yellow-500 outline-none" onkeypress="handleLoginKeyPress(event)">
                <input type="password" id="admin-password" placeholder="Senha" class="w-full bg-gray-900 border border-gray-600 rounded p-3 text-white focus:border-yellow-500 outline-none" onkeypress="handleLoginKeyPress(event)">
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="closeModals()" class="text-gray-400 hover:text-white px-4">Cancelar</button>
                <button onclick="performAdminLogin()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-bold">Entrar</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-600 text-white px-6 py-3 rounded shadow-lg transform translate-y-20 transition opacity-0 z-50 font-bold pointer-events-none">Ação realizada!</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, updateDoc, doc, increment, serverTimestamp, arrayUnion, getDoc, deleteDoc, getDocs, setDoc, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CONFIGS
        const firebaseConfig = {
            apiKey: "AIzaSyDlO2KnSJR0RD3f2bn025qzAJa619lDY7M",
            authDomain: "tierlistninonline.firebaseapp.com",
            projectId: "tierlistninonline",
            storageBucket: "tierlistninonline.firebasestorage.app",
            messagingSenderId: "962890522909",
            appId: "1:962890522909:web:be2968f4bf5cc40d1881f4",
            measurementId: "G-7JL99VSSH2"
        };
        const GITHUB_USER = "aurioshlookin";
        const GITHUB_REPO = "tierlistninonline";
        const CATEGORY_PATHS = {
            'ninjas': ['imagens/ninjas', 'imagens/ninja'],
            'maestrias': ['imagens/maestrias', 'imagens/masteries'],
            'jutsus': ['imagens/jutsus', 'imagens/jutsu'],
            'armas': ['imagens/armas', 'imagens/weapons']
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ESTADO GLOBAL
        let appState = {
            currentUser: null,
            isAdmin: false,
            currentCategory: 'ninjas',
            currentDocId: null, 
            imagesCache: {}, 
            communityData: {}, 
            battleStats: {}, 
            currentFighters: [],
            rankingMonth: null 
        };

        // Função global definida no escopo window para acesso imediato
        window.resetEditorState = () => {
            appState.currentDocId = null;
        }

        // --- AUTH ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                appState.currentUser = user;
                appState.isAdmin = !user.isAnonymous;
                updateAuthUI();
                renderCommunityGrid(); 
            } else {
                signInAnonymously(auth).catch(console.error);
            }
        });

        function updateAuthUI() {
            const loginBtn = document.getElementById('login-btn');
            const adminInfo = document.getElementById('admin-info');
            if (appState.isAdmin) {
                loginBtn.classList.add('hidden');
                adminInfo.classList.remove('hidden');
                adminInfo.classList.add('flex');
            } else {
                loginBtn.classList.remove('hidden');
                adminInfo.classList.add('hidden');
                adminInfo.classList.remove('flex');
            }
        }

        window.openLoginModal = () => document.getElementById('login-modal').classList.remove('hidden');
        window.closeModals = () => {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('category-modal').classList.add('hidden');
            document.getElementById('minigame-setup-modal').classList.add('hidden');
        };

        window.handleLoginKeyPress = (e) => {
            if (e.key === "Enter") performAdminLogin();
        }

        window.performAdminLogin = () => {
            const email = document.getElementById('admin-email').value;
            const pass = document.getElementById('admin-password').value;
            if(!email || !pass) return alert("Preencha email e senha");
            signInWithEmailAndPassword(auth, email, pass).then(() => {
                closeModals();
                showToast("Admin Logado!");
            }).catch(e => alert("Erro: " + e.message));
        };

        window.logout = () => {
            signOut(auth).then(() => showToast("Desconectado."));
        };

        // --- NAVEGAÇÃO ---
        window.navigateTo = (screen) => {
            ['home-screen', 'editor-screen', 'view-screen', 'minigame-screen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
                document.getElementById(id).classList.remove('flex');
            });
            
            if (screen === 'home') {
                document.getElementById('home-screen').classList.remove('hidden');
                if(window.resetEditorState) window.resetEditorState();
            } else if (screen === 'minigame') {
                const el = document.getElementById('minigame-screen');
                el.classList.remove('hidden');
                el.classList.add('flex');
            }
            window.scrollTo(0,0);
        };

        // ==========================================
        // LÓGICA DO MINI GAME
        // ==========================================
        
        window.openMiniGameSetup = () => document.getElementById('minigame-setup-modal').classList.remove('hidden');

        function getCurrentMonthId() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }

        async function loadAvailableMonths(category) {
            try {
                const docSnap = await getDoc(doc(db, "meta", "battles"));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const months = data[`months_${category}`] || [];
                    return months.sort().reverse();
                }
            } catch (e) { console.error("Erro meta meses:", e); }
            return [];
        }

        async function initMonthSelector(category) {
            const selector = document.getElementById('month-selector');
            selector.innerHTML = '';
            
            let months = await loadAvailableMonths(category);
            const current = getCurrentMonthId();
            
            if (!months.includes(current)) months.unshift(current);
            months = [...new Set(months)].sort().reverse();

            months.forEach(m => {
                const [y, monthNum] = m.split('-');
                const date = new Date(parseInt(y), parseInt(monthNum) - 1, 1);
                const label = date.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
                
                const opt = document.createElement('option');
                opt.value = m;
                opt.innerText = label.charAt(0).toUpperCase() + label.slice(1);
                selector.appendChild(opt);
            });
            
            selector.value = current;
            appState.rankingMonth = current;
        }

        window.startMiniGame = async (category) => {
            closeModals();
            appState.currentCategory = category;
            appState.rankingMonth = getCurrentMonthId(); 
            
            document.getElementById('game-category-title').innerText = category.charAt(0).toUpperCase() + category.slice(1);
            await initMonthSelector(category);
            navigateTo('minigame');
            await loadImagesForCategory(category);
            await loadBattleStats(category, getCurrentMonthId()); 
            pickNextBattle();
            updateRankingUI();
        };

        window.changeRankingMonth = async (monthId) => {
            appState.rankingMonth = monthId;
            await loadBattleStats(appState.currentCategory, monthId);
            updateRankingUI();
        };

        async function loadBattleStats(category, monthId) {
            const q = query(collection(db, "battles"), 
                where('category', '==', category),
                where('month', '==', monthId)
            );
            
            try {
                const snapshot = await getDocs(q);
                appState.battleStats = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    appState.battleStats[data.name] = data;
                });
            } catch (e) { 
                console.error("Erro stats:", e); 
            }
        }

        function getSeenBattles() {
            if (!appState.currentUser) return new Set();
            const key = `seen_${appState.currentUser.uid}_${appState.currentCategory}_${getCurrentMonthId()}`;
            const stored = localStorage.getItem(key);
            return stored ? new Set(JSON.parse(stored)) : new Set();
        }

        function markBattleSeen(n1, n2) {
            if (!appState.currentUser) return;
            const key = `seen_${appState.currentUser.uid}_${appState.currentCategory}_${getCurrentMonthId()}`;
            const set = getSeenBattles();
            const pairId = [n1, n2].sort().join('::'); 
            set.add(pairId);
            localStorage.setItem(key, JSON.stringify([...set]));
        }

        window.pickNextBattle = () => {
            const category = appState.currentCategory;
            const allImages = appState.imagesCache[category];
            
            // TRATAMENTO SEM IMAGENS
            const battleArea = document.getElementById('battle-area');
            const errorMsg = document.getElementById('battle-error-msg');
            const loading = document.getElementById('battle-loading');

            if (!allImages || allImages.length < 2) {
                battleArea.classList.add('hidden');
                loading.classList.add('hidden');
                errorMsg.classList.remove('hidden');
                errorMsg.innerText = "Não há imagens suficientes para batalhar nesta categoria.";
                return;
            } else {
                battleArea.classList.remove('hidden');
                errorMsg.classList.add('hidden');
            }

            const seen = getSeenBattles();
            const pool = allImages.map(img => {
                const name = img.name.replace(/\.[^/.]+$/, "");
                const stats = appState.battleStats[name] || { battles: 0, wins: 0 };
                return { name: name, url: img.download_url, battles: stats.battles || 0 };
            });

            pool.sort((a, b) => a.battles - b.battles);

            let fighterA, fighterB;
            for (let i = 0; i < pool.length; i++) {
                const candidateA = pool[i];
                for (let j = 0; j < pool.length; j++) {
                    if (i === j) continue;
                    const candidateB = pool[j];
                    const pairId = [candidateA.name, candidateB.name].sort().join('::');
                    if (!seen.has(pairId)) {
                        fighterA = candidateA;
                        fighterB = candidateB;
                        break;
                    }
                }
                if (fighterA) break;
            }

            if (!fighterA) {
                 const minBattles = pool[0].battles;
                 const candidatesA = pool.filter(p => p.battles === minBattles);
                 fighterA = candidatesA[Math.floor(Math.random() * candidatesA.length)];
                 let candidatesB = pool.filter(p => p.name !== fighterA.name).slice(0, Math.max(5, pool.length / 5));
                 fighterB = candidatesB[Math.floor(Math.random() * candidatesB.length)];
            }

            appState.currentFighters = [fighterA, fighterB];
            renderFighter(1, fighterA);
            renderFighter(2, fighterB);
        };

        window.skipBattle = () => {
            if(appState.currentFighters.length === 2) {
                markBattleSeen(appState.currentFighters[0].name, appState.currentFighters[1].name);
            }
            pickNextBattle();
        };

        function renderFighter(slot, fighter) {
            const el = document.getElementById(`fighter-${slot}`);
            el.querySelector('.ninja-image').style.backgroundImage = `url('${fighter.url}')`;
            el.querySelector('.ninja-name').innerText = fighter.name;
            el.classList.remove('ring-4', 'ring-green-500', 'opacity-50');
        }

        window.voteBattle = async (winnerSlot) => {
            const loading = document.getElementById('battle-loading');
            loading.classList.remove('hidden');
            
            const winner = appState.currentFighters[winnerSlot - 1];
            const loser = appState.currentFighters[winnerSlot === 1 ? 1 : 0];
            const category = appState.currentCategory;
            const currentMonth = getCurrentMonthId(); 

            markBattleSeen(winner.name, loser.name);

            const winnerRef = doc(db, "battles", `${category}_${currentMonth}_${winner.name}`);
            const loserRef = doc(db, "battles", `${category}_${currentMonth}_${loser.name}`);
            const metaRef = doc(db, "meta", "battles");

            try {
                // Prepara thumbnails para salvar
                const winnerThumb = await generateThumbnail(winner.url);
                const loserThumb = await generateThumbnail(loser.url);

                // Update data with thumbnails
                const winnerUpdate = { 
                    battles: increment(1), 
                    wins: increment(1),
                    name: winner.name,
                    category: category,
                    month: currentMonth,
                    beat: { [loser.name]: increment(1) }
                };
                if(winnerThumb) winnerUpdate.thumbnail = winnerThumb;

                const loserUpdate = { 
                    battles: increment(1),
                    name: loser.name,
                    category: category,
                    month: currentMonth,
                    lost_to: { [winner.name]: increment(1) }
                };
                if(loserThumb) loserUpdate.thumbnail = loserThumb;

                await Promise.all([
                    setDoc(winnerRef, winnerUpdate, { merge: true }),
                    setDoc(loserRef, loserUpdate, { merge: true }),
                    setDoc(metaRef, { [`months_${category}`]: arrayUnion(currentMonth) }, { merge: true }).catch(err => console.log("Meta err", err))
                ]);

                if (appState.rankingMonth === currentMonth) {
                    updateLocalStats(winner.name, true, loser.name);
                    updateLocalStats(loser.name, false, winner.name);
                    updateRankingUI();
                }

                showToast(`Voto registrado!`);
                pickNextBattle();

            } catch(e) {
                console.error(e);
                alert("Erro ao salvar voto: " + e.message);
            } finally {
                loading.classList.add('hidden');
            }
        };

        // Gera thumbnail para o ranking
        async function generateThumbnail(imgUrl) {
            try {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = imgUrl;
                });
                
                const canvas = document.createElement("canvas");
                canvas.width = 50; canvas.height = 50;
                const ctx = canvas.getContext("2d");
                // Center crop
                const scale = Math.max(canvas.width / img.width, canvas.height / img.height);
                const x = (canvas.width / 2) - (img.width / 2) * scale;
                const y = (canvas.height / 2) - (img.height / 2) * scale;
                ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                return canvas.toDataURL("image/jpeg", 0.7);
            } catch(e) { return null; }
        }

        function updateLocalStats(name, won, opponentName) {
            if(!appState.battleStats[name]) appState.battleStats[name] = { name: name, battles: 0, wins: 0, beat: {}, lost_to: {} };
            const s = appState.battleStats[name];
            s.battles++;
            if(won) {
                s.wins++;
                s.beat = s.beat || {};
                s.beat[opponentName] = (s.beat[opponentName] || 0) + 1;
            } else {
                s.lost_to = s.lost_to || {};
                s.lost_to[opponentName] = (s.lost_to[opponentName] || 0) + 1;
            }
        }

        function findMaxKey(obj) {
            if (!obj) return "-";
            let maxKey = "-";
            let maxValue = 0;
            for (const [key, value] of Object.entries(obj)) {
                if (value > maxValue) {
                    maxValue = value;
                    maxKey = key;
                }
            }
            return maxKey !== "-" ? `${maxKey} (${maxValue})` : "-";
        }

        function updateRankingUI() {
            const tbody = document.getElementById('game-ranking-body');
            tbody.innerHTML = '';

            const ranking = Object.values(appState.battleStats)
                .map(item => {
                    const wins = item.wins || 0;
                    const battles = item.battles || 0;
                    const losses = battles - wins;
                    const winRate = battles > 0 ? ((wins / battles) * 100).toFixed(1) : 0;
                    const victim = findMaxKey(item.beat);
                    const nemesis = findMaxKey(item.lost_to);
                    
                    return { ...item, wins, battles, losses, winRate, victim, nemesis };
                })
                .sort((a, b) => b.wins - a.wins);

            if(ranking.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4">Nenhuma batalha registrada neste mês.</td></tr>';
                return;
            }

            ranking.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-gray-800 border-b border-gray-700' : 'bg-gray-700 border-b border-gray-600';
                
                let wrClass = "text-gray-400";
                if(item.winRate >= 70) wrClass = "text-green-400 font-bold";
                else if(item.winRate <= 30) wrClass = "text-red-400";

                row.innerHTML = `
                    <td class="px-6 py-4 text-center font-bold ${index < 3 ? 'text-yellow-500' : 'text-gray-500'}">${index+1}</td>
                    <td class="px-6 py-4 font-medium text-white whitespace-nowrap">${item.name}</td>
                    <td class="px-6 py-4 text-center text-green-400 font-bold">${item.wins}</td>
                    <td class="px-6 py-4 text-center text-red-400">${item.losses}</td>
                    <td class="px-6 py-4 text-center text-blue-300 font-mono">${item.battles}</td>
                    <td class="px-6 py-4 text-center ${wrClass}">${item.winRate}%</td>
                    <td class="px-6 py-4 text-left text-xs text-gray-300">${item.victim}</td>
                    <td class="px-6 py-4 text-left text-xs text-gray-300">${item.nemesis}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // ==========================================
        // SISTEMA TIER LIST (GRID & EDITOR)
        // ==========================================

        const q = query(collection(db, "tierlists"), orderBy("votes", "desc"));
        onSnapshot(q, (snapshot) => {
            appState.communitySnapshot = []; 
            snapshot.forEach(doc => {
                appState.communitySnapshot.push({ id: doc.id, ...doc.data() });
            });
            renderCommunityGrid();
        });

        window.renderCommunityGrid = () => {
            const grid = document.getElementById('community-grid');
            if(!appState.communitySnapshot) return;
            grid.innerHTML = '';
            
            appState.communitySnapshot.forEach(data => {
                const id = data.id;
                appState.communityData[id] = data; 
                const card = document.createElement('div');
                card.className = "bg-gray-800 rounded-lg overflow-hidden border border-gray-700 hover:border-yellow-500 transition cursor-pointer flex flex-col group relative";
                card.onclick = () => window.openTierView(id);
                
                let previewHtml = '';
                if (data.thumbnail) {
                    previewHtml = `<div class="h-32 w-full bg-cover bg-top" style="background-image: url('${data.thumbnail}')"></div>`;
                } else {
                    let topItems = [];
                    if (data.tiers && Array.isArray(data.tiers)) {
                        const first = data.tiers.find(t => t.items && t.items.length > 0);
                        if (first) topItems = first.items.slice(0, 4);
                    }
                    const catPaths = CATEGORY_PATHS[data.category || 'ninjas'];
                    const basePath = catPaths ? catPaths[0] : 'imagens/ninjas';
                    const baseUrl = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/${basePath}/`;

                    previewHtml = `<div class="bg-black h-32 flex items-center justify-center gap-1 p-2">`;
                    if (topItems.length > 0) {
                        topItems.forEach(item => previewHtml += `<div class="w-12 h-12 bg-cover bg-center rounded border border-gray-600" style="background-image: url('${baseUrl}${item}.png')"></div>`);
                    } else {
                        previewHtml += `<span class="text-gray-600 text-xs">Vazio</span>`;
                    }
                    previewHtml += `</div>`;
                }

                let actionBtns = '';
                const isOwner = appState.currentUser && data.userId === appState.currentUser.uid;
                let btnsHtml = '';
                
                if (isOwner || appState.isAdmin) {
                    btnsHtml += `<button onclick="event.stopPropagation(); window.currentModalId='${id}'; editCurrentTierList()" class="bg-black bg-opacity-70 text-yellow-500 hover:text-white p-1.5 rounded-full text-xs shadow-md mx-1"><i class="fas fa-pencil-alt"></i></button>`;
                }
                if (appState.isAdmin) {
                    btnsHtml += `<button onclick="event.stopPropagation(); window.currentModalId='${id}'; deleteCurrentTierList()" class="bg-black bg-opacity-70 text-red-500 hover:text-white p-1.5 rounded-full text-xs shadow-md mx-1"><i class="fas fa-trash"></i></button>`;
                }
                if (btnsHtml) actionBtns = `<div class="absolute top-2 right-2 flex z-20">${btnsHtml}</div>`;

                const isVoted = data.voterIds && appState.currentUser && data.voterIds.includes(appState.currentUser.uid);
                const voteClass = isVoted ? "text-green-500" : "text-gray-400 hover:text-yellow-500";
                
                const creatorId = data.userId ? `#${data.userId.slice(0, 4)}` : '';

                card.innerHTML = `
                    ${actionBtns}
                    ${previewHtml}
                    <div class="p-3 flex flex-col flex-grow">
                        <h4 class="font-bold text-white text-md truncate group-hover:text-yellow-400">${data.title}</h4>
                        <div class="flex justify-between items-center mt-auto pt-2">
                            <div class="flex flex-col">
                                <span class="text-xs text-gray-400 truncate max-w-[120px] font-bold">${data.creatorName}</span>
                                <span class="text-[10px] text-gray-600 font-mono">${creatorId}</span>
                            </div>
                            <div class="flex items-center gap-1 bg-gray-900 px-2 py-1 rounded border border-gray-700 hover:border-gray-500 transition" onclick="event.stopPropagation(); vote('${id}')">
                                <i class="fas fa-caret-up ${voteClass}"></i>
                                <span class="text-sm font-mono font-bold">${data.votes || 0}</span>
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            if (grid.innerHTML === '') grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">Nenhuma Tier List encontrada.</div>';
        };

        // --- OUTRAS FUNÇÕES ---
        window.openCategoryModal = () => document.getElementById('category-modal').classList.remove('hidden');
        window.showHomeScreen = () => navigateTo('home');
        
        window.startEditor = async (category) => {
            closeModals();
            appState.currentCategory = category;
            appState.currentDocId = null;
            
            navigateTo('editor'); 
            document.getElementById('home-screen').classList.add('hidden');
            document.getElementById('editor-screen').classList.remove('hidden');
            document.getElementById('editor-screen').classList.add('flex');

            document.getElementById('category-display').innerText = category.charAt(0).toUpperCase() + category.slice(1);
            document.getElementById('tier-title').value = "";
            initBoard();
            await loadImagesForCategory(category);
        };

        const defaultTiers = [
            { label: 'S', color: '#ff7f7f' }, { label: 'A', color: '#ffbf7f' },
            { label: 'B', color: '#ffdf7f' }, { label: 'C', color: '#ffff7f' }, { label: 'D', color: '#bfff7f' }
        ];

        window.addTierRow = (label = 'New', color = '#cccccc', contentItems = []) => {
            const board = document.getElementById('tier-board');
            const row = document.createElement('div');
            row.className = 'flex border-b border-gray-600 bg-gray-900 tier-row';
            row.innerHTML = `
                <div class="tier-label" style="background-color: ${color};" contenteditable="true" spellcheck="false" onblur="this.style.backgroundColor = this.nextElementSibling.nextElementSibling.querySelector('input').value">${label}</div>
                <div class="tier-content" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                <div class="tier-controls">
                    <button onclick="moveRow(this, -1)" class="text-gray-400 hover:text-white text-xs"><i class="fas fa-chevron-up"></i></button>
                    <div class="relative group h-4 w-4"><i class="fas fa-palette text-gray-400 hover:text-white text-xs cursor-pointer absolute inset-0 text-center"></i><input type="color" value="${color}" class="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer" oninput="this.parentElement.parentElement.parentElement.querySelector('.tier-label').style.backgroundColor = this.value"></div>
                    <button onclick="deleteRow(this)" class="text-red-500 hover:text-red-400 text-xs"><i class="fas fa-trash"></i></button>
                    <button onclick="moveRow(this, 1)" class="text-gray-400 hover:text-white text-xs"><i class="fas fa-chevron-down"></i></button>
                </div>`;
            board.appendChild(row);
            if (contentItems && contentItems.length > 0) {
                const contentDiv = row.querySelector('.tier-content');
                contentItems.forEach(itemName => {
                    let itemEl = createDraggableElement(itemName, getImageUrl(itemName));
                    contentDiv.appendChild(itemEl);
                });
            }
        };

        function initBoard() {
            document.getElementById('tier-board').innerHTML = '';
            defaultTiers.forEach(t => window.addTierRow(t.label, t.color));
        }

        async function loadImagesForCategory(category) {
            const bank = document.getElementById('image-bank');
            bank.innerHTML = '';
            if (appState.imagesCache[category]) { renderImagesToBank(appState.imagesCache[category]); return; }
            document.getElementById('loading-indicator').classList.remove('hidden');
            
            // STRICT MODE: ONLY USE DEFINED PATHS, NO FALLBACK TO NINJAS
            const paths = CATEGORY_PATHS[category];
            if (!paths) {
                console.error("Invalid category:", category);
                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('error-message').innerText = "Categoria inválida.";
                document.getElementById('error-message').classList.remove('hidden');
                return;
            }

            let found = false;
            for (const path of paths) {
                try {
                    const response = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${path}`);
                    if (response.ok) {
                        const files = await response.json();
                        const imageFiles = files.filter(f => f.name.match(/\.(png|jpg|jpeg|gif)$/i));
                        if (imageFiles.length > 0) {
                            appState.imagesCache[category] = imageFiles;
                            renderImagesToBank(imageFiles);
                            found = true; break;
                        }
                    }
                } catch (e) {}
            }
            document.getElementById('loading-indicator').classList.add('hidden');
            if(!found) {
                document.getElementById('error-message').innerText = "Nenhuma imagem encontrada nesta categoria.";
                document.getElementById('error-message').classList.remove('hidden');
            } else {
                document.getElementById('error-message').classList.add('hidden');
            }
        }

        function renderImagesToBank(files) {
            const bank = document.getElementById('image-bank');
            files.forEach((file, index) => {
                const name = file.name.replace(/\.[^/.]+$/, "");
                if (document.querySelector(`.draggable-item[data-name="${name}"]`)) return;
                bank.appendChild(createDraggableElement(name, file.download_url, index));
            });
        }

        function createDraggableElement(name, url, index = 0) {
            const div = document.createElement('div');
            div.className = 'draggable-item'; div.draggable = true; div.id = `item-${name}-${index}-${Date.now()}`;
            div.dataset.name = name; div.dataset.url = url;
            div.innerHTML = `<div class="ninja-image" style="background-image: url('${url}')"></div><div class="ninja-name">${name}</div>`;
            div.addEventListener('dragstart', (e) => { e.dataTransfer.setData("text/plain", e.target.id); e.target.style.opacity = '0.5'; });
            div.addEventListener('dragend', (e) => e.target.style.opacity = '1');
            return div;
        }

        function getImageUrl(name) {
            if (appState.imagesCache[appState.currentCategory]) {
                const file = appState.imagesCache[appState.currentCategory].find(f => f.name.startsWith(name));
                if (file) return file.download_url;
            }
            return `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/${CATEGORY_PATHS[appState.currentCategory][0]}/${name}.png`;
        }

        window.allowDrop = (ev) => ev.preventDefault();
        window.drop = (ev) => {
            ev.preventDefault();
            const data = ev.dataTransfer.getData("text/plain");
            const draggedElement = document.getElementById(data);
            if (!draggedElement) return;
            let target = ev.target;
            if (target.closest('.draggable-item')) target = target.closest('.draggable-item').parentElement;
            if (target && (target.classList.contains('tier-content') || target.id === 'image-bank')) target.appendChild(draggedElement);
        };
        window.deleteRow = (btn) => { if(confirm('Apagar linha?')) btn.closest('.tier-row').remove(); }; 
        window.moveRow = (btn, dir) => {
            const row = btn.closest('.tier-row');
            if (dir === -1 && row.previousElementSibling) row.parentElement.insertBefore(row, row.previousElementSibling);
            else if (dir === 1 && row.nextElementSibling) row.parentElement.insertBefore(row.nextElementSibling, row);
        };

        window.saveTierList = async () => {
            if (!appState.currentUser) { alert("Conectando..."); return; }
            const title = document.getElementById('tier-title').value.trim();
            const creator = document.getElementById('creator-name').value.trim();
            if (!title || !creator) { alert("Preencha Título e Nick."); return; }
            
            const saveBtn = document.querySelector('button[onclick="saveTierList()"]');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';
            saveBtn.disabled = true;

            const tiersData = [];
            document.querySelectorAll('.tier-row').forEach(row => {
                const items = [];
                row.querySelector('.tier-content').querySelectorAll('.draggable-item').forEach(i => items.push(i.dataset.name));
                tiersData.push({ label: row.querySelector('.tier-label').innerText.trim(), color: row.querySelector('.tier-label').style.backgroundColor, items: items });
            });

            // GERA THUMBNAIL
            let thumbnail = null;
            try {
                const boardEl = document.getElementById('tier-board');
                const canvas = await html2canvas(boardEl, {
                    useCORS: true,
                    scale: 1,
                    backgroundColor: "#111"
                });
                const extraCanvas = document.createElement("canvas");
                const ratio = canvas.height / canvas.width;
                const w = 320;
                const h = w * ratio;
                extraCanvas.width = w;
                extraCanvas.height = h;
                const ctx = extraCanvas.getContext("2d");
                ctx.drawImage(canvas, 0, 0, w, h);
                thumbnail = extraCanvas.toDataURL("image/jpeg", 0.7);
            } catch(e) {
                console.warn("Thumbnail failed", e);
            }

            const payload = { 
                title, 
                creatorName: creator, 
                tiers: tiersData, 
                category: appState.currentCategory, 
                userId: appState.currentUser.uid, 
                updatedAt: serverTimestamp(),
                version: 3,
                thumbnail: thumbnail
            };

            try {
                let docId = appState.currentDocId;
                if (docId) { await updateDoc(doc(db, "tierlists", docId), payload); showToast("Salvo!"); }
                else { payload.createdAt = serverTimestamp(); payload.votes = 0; payload.voterIds = []; const ref = await addDoc(collection(db, "tierlists"), payload); docId = ref.id; showToast("Criado!"); }
                appState.communityData[docId] = { ...payload, id: docId, votes: payload.votes || 0 };
                window.openTierView(docId);
            } catch (e) { alert("Erro: " + e.message); }
            finally {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        };

        window.openTierView = (id) => {
            window.currentModalId = id; const data = appState.communityData[id]; if (!data) return;
            document.getElementById('view-title').innerText = data.title;
            document.getElementById('view-creator').innerText = data.creatorName;
            const isOwner = appState.currentUser && data.userId === appState.currentUser.uid;
            document.getElementById('view-edit-btn').classList.toggle('hidden', !(isOwner || appState.isAdmin));
            document.getElementById('view-delete-btn').classList.toggle('hidden', !appState.isAdmin);
            const container = document.getElementById('view-content'); container.innerHTML = '';
            const catPaths = CATEGORY_PATHS[data.category || 'ninjas'];
            const baseUrl = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/${catPaths ? catPaths[0] : 'imagens/ninjas'}/`;
            if (data.tiers) data.tiers.forEach(tier => {
                const row = document.createElement('div'); row.className = 'flex border-b border-gray-700 bg-gray-900';
                const itemsHtml = (tier.items || []).map(name => `<div class="draggable-item static-item border-none shadow-none bg-transparent"><div class="ninja-image" style="background-image: url('${baseUrl}${name}.png')"></div><div class="ninja-name">${name}</div></div>`).join('');
                row.innerHTML = `<div class="tier-label" style="background-color: ${tier.color};">${tier.label}</div><div class="tier-content bg-[#111]">${itemsHtml}</div>`;
                container.appendChild(row);
            });
            navigateTo('view-screen'); document.getElementById('view-screen').classList.remove('hidden'); document.getElementById('view-screen').classList.add('flex');
        };

        window.editCurrentTierList = async () => {
            const id = window.currentModalId; const data = appState.communityData[id]; if (!data) return;
            await startEditor(data.category || 'ninjas');
            appState.currentDocId = id; document.getElementById('tier-title').value = data.title; document.getElementById('creator-name').value = data.creatorName;
            document.getElementById('tier-board').innerHTML = '';
            if (Array.isArray(data.tiers)) data.tiers.forEach(t => window.addTierRow(t.label, t.color, t.items));
            showToast("Editando...");
        };

        window.deleteCurrentTierList = async () => {
            if(!confirm("Tem certeza?")) return;
            try { await deleteDoc(doc(db, "tierlists", window.currentModalId)); showToast("Excluída."); showHomeScreen(); } catch (e) { alert(e.message); }
        };

        window.vote = async (docId) => {
            if (!appState.currentUser) return;
            // Check if already voted locally to avoid call
            const data = appState.communityData[docId];
            if (data && data.voterIds && data.voterIds.includes(appState.currentUser.uid)) {
                alert("Você já votou nesta lista!");
                return;
            }
            try { await updateDoc(doc(db, "tierlists", docId), { votes: increment(1), voterIds: arrayUnion(appState.currentUser.uid) }); } catch (e) {}
        };

        window.downloadTierListImage = () => {
            html2canvas(document.getElementById('view-capture-area'), { useCORS: true, backgroundColor: "#111", scale: 2 }).then(canvas => {
                const link = document.createElement('a'); link.download = `NinTier-${Date.now()}.png`; link.href = canvas.toDataURL(); link.click();
            });
        };

        function showToast(msg) {
            const t = document.getElementById('toast'); t.innerText = msg;
            t.classList.remove('translate-y-20', 'opacity-0'); setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        }
    </script>
</body>
</html>
