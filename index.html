<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nin Online - Tier List Maker</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .tier-label {
            width: 80px;
            min-width: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.5rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            outline: none;
            cursor: text;
        }
        .tier-content {
            flex-grow: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.5rem;
            min-height: 120px; /* Aumentei um pouco para caber os bonecos maiores */
            background-color: #1a1a1a;
            align-items: flex-start; /* Alinha no topo */
        }
        .tier-controls {
            width: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #2d2d2d;
            gap: 5px;
            padding: 5px 0;
        }
        
        /* NOVO ESTILO DOS NINJAS */
        .draggable-item {
            width: 80px;  /* Mais largo */
            height: 110px; /* Mais alto para caber o corpo todo */
            cursor: grab;
            transition: transform 0.1s;
            background-color: #333;
            border: 2px solid transparent;
            border-radius: 6px;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* Nome fica no final */
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        /* A imagem do boneco */
        .ninja-image {
            width: 100%;
            height: 100%;
            background-size: contain; /* Mostra a imagem inteira sem cortar */
            background-repeat: no-repeat;
            background-position: center bottom; /* Personagem 'em pé' no fundo */
            margin-bottom: 20px; /* Espaço para o nome */
            
            /* MELHORIA PIXEL PERFECT */
            image-rendering: pixelated;       /* Padrão moderno */
            image-rendering: -moz-crisp-edges; /* Firefox */
            image-rendering: crisp-edges;      /* Outros */
        }

        /* O nome abaixo */
        .ninja-name {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0,0,0,0.85);
            color: #fff;
            font-size: 10px;
            text-align: center;
            padding: 2px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-top: 1px solid #444;
        }

        .draggable-item:hover {
            transform: scale(1.05);
            border-color: #fbbf24;
            z-index: 10;
        }
        .draggable-item:active {
            cursor: grabbing;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #777; }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans min-h-screen">

    <!-- Navbar -->
    <nav class="bg-black border-b border-gray-800 p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-yellow-500">
                <i class="fas fa-scroll mr-2"></i>Nin Online Tier Maker
            </h1>
            <div id="auth-status" class="text-sm text-gray-400">
                <i class="fas fa-spinner fa-spin"></i> Conectando...
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 md:p-8">
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Coluna Esquerda: Tier List Board -->
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 shadow-lg">
                    
                    <!-- Área de Inputs (Título e Nick) -->
                    <div class="flex flex-col md:flex-row gap-4 mb-4 items-end">
                        <div class="flex-grow w-full">
                            <label class="text-xs text-gray-400 font-bold ml-1">NOME DA TIER LIST *</label>
                            <input type="text" id="tier-title" placeholder="Ex: Melhores Ninjas PvP..." 
                                class="bg-gray-900 text-white text-lg font-bold px-4 py-2 rounded border border-gray-600 focus:border-yellow-500 outline-none w-full">
                        </div>
                        
                        <div class="w-full md:w-48">
                            <label class="text-xs text-gray-400 font-bold ml-1">SEU NICK *</label>
                            <input type="text" id="creator-name" placeholder="Ex: Auriosh" maxlength="15"
                                class="bg-gray-900 text-white text-lg px-4 py-2 rounded border border-gray-600 focus:border-yellow-500 outline-none w-full">
                        </div>

                        <div class="flex gap-2 w-full md:w-auto">
                             <button onclick="addTierRow()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold transition text-sm h-[46px]" title="Adicionar Linha">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button onclick="saveTierList()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded font-bold transition flex items-center justify-center gap-2 h-[46px] flex-grow md:flex-grow-0">
                                <i class="fas fa-save"></i> SALVAR
                            </button>
                         </div>
                    </div>

                    <!-- As Tiers (Geradas Dinamicamente) -->
                    <div id="tier-board" class="border border-gray-600 rounded overflow-hidden">
                        <!-- Javascript vai preencher isso aqui -->
                    </div>
                </div>

                <!-- Banco de Imagens -->
                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-bold text-gray-300">Banco de Imagens</h3>
                        <span id="loading-indicator" class="text-xs text-yellow-500 hidden"><i class="fas fa-sync fa-spin"></i> Procurando no GitHub...</span>
                    </div>
                    <div id="image-bank" class="flex flex-wrap gap-2 p-4 bg-gray-900 rounded min-h-[150px]" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <!-- Imagens -->
                    </div>
                    <div id="error-message" class="text-red-400 text-xs p-2 hidden"></div>
                </div>
            </div>

            <!-- Coluna Direita: Comunidade -->
            <div class="lg:col-span-1">
                <div class="bg-gray-800 rounded-lg border border-gray-700 shadow-lg p-4 h-full flex flex-col">
                    <h2 class="text-xl font-bold text-yellow-500 mb-4 border-b border-gray-700 pb-2">
                        <i class="fas fa-fire mr-2"></i>Tier Lists da Comunidade
                    </h2>
                    <div id="community-list" class="flex-1 overflow-y-auto space-y-4 max-h-[800px] pr-2">
                        <p class="text-gray-500 text-center mt-10">Carregando listas...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Feedback -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-600 text-white px-6 py-3 rounded shadow-lg transform translate-y-20 transition opacity-0 z-50 font-bold">
        Salvo com sucesso!
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, updateDoc, doc, increment, serverTimestamp, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CONFIGURAÇÃO DO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDlO2KnSJR0RD3f2bn025qzAJa619lDY7M",
            authDomain: "tierlistninonline.firebaseapp.com",
            projectId: "tierlistninonline",
            storageBucket: "tierlistninonline.firebasestorage.app",
            messagingSenderId: "962890522909",
            appId: "1:962890522909:web:be2968f4bf5cc40d1881f4",
            measurementId: "G-7JL99VSSH2"
        };

        // --- CONFIGURAÇÃO GITHUB ---
        const GITHUB_USER = "aurioshlookin";
        const GITHUB_REPO = "tierlistninonline";
        const PATHS_TO_TRY = [
            "imagens/ninja",
            "imagens/ninjas",  
            "Imagens/Ninjas", 
            "images/ninja", 
            "ninjas",         
            ""                
        ];

        let BASE_IMAGE_URL = "";

        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        signInAnonymously(auth).catch(console.error);
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-status').innerHTML = `<i class="fas fa-user-ninja text-green-400"></i> ID: ${user.uid.slice(0,6)}`;
            }
        });

        // --- GERENCIAMENTO DE TIERS ---
        const defaultTiers = [
            { label: 'S', color: '#ff7f7f' },
            { label: 'A', color: '#ffbf7f' },
            { label: 'B', color: '#ffdf7f' },
            { label: 'C', color: '#ffff7f' },
            { label: 'D', color: '#bfff7f' }
        ];

        window.addTierRow = (label = 'New', color = '#cccccc', contentIds = []) => {
            const board = document.getElementById('tier-board');
            const row = document.createElement('div');
            row.className = 'flex border-b border-gray-600 bg-gray-900 tier-row';
            
            row.innerHTML = `
                <div class="tier-label" style="background-color: ${color};" contenteditable="true" spellcheck="false" 
                     onblur="this.style.backgroundColor = this.nextElementSibling.nextElementSibling.querySelector('input').value">
                    ${label}
                </div>
                <div class="tier-content" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                <div class="tier-controls">
                    <button onclick="moveRow(this, -1)" class="text-gray-400 hover:text-white text-xs" title="Subir"><i class="fas fa-chevron-up"></i></button>
                    <div class="relative group">
                        <i class="fas fa-palette text-gray-400 hover:text-white text-xs cursor-pointer"></i>
                        <input type="color" value="${color}" 
                            class="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer"
                            oninput="this.parentElement.parentElement.parentElement.querySelector('.tier-label').style.backgroundColor = this.value">
                    </div>
                    <button onclick="deleteRow(this)" class="text-red-500 hover:text-red-400 text-xs" title="Excluir"><i class="fas fa-trash"></i></button>
                    <button onclick="moveRow(this, 1)" class="text-gray-400 hover:text-white text-xs" title="Descer"><i class="fas fa-chevron-down"></i></button>
                </div>
            `;
            board.appendChild(row);

            if (contentIds.length > 0) {
                const contentDiv = row.querySelector('.tier-content');
                contentIds.forEach(id => {
                    // Tenta encontrar no banco primeiro
                    const existingItem = document.querySelector(`.draggable-item[data-name="${id}"]`);
                    if (existingItem) {
                        contentDiv.appendChild(existingItem);
                    }
                });
            }
        };

        window.deleteRow = (btn) => {
            if(confirm('Apagar Tier? Os itens voltarão para o banco.')) {
                const row = btn.closest('.tier-row');
                const items = row.querySelectorAll('.draggable-item');
                const bank = document.getElementById('image-bank');
                items.forEach(item => bank.appendChild(item));
                row.remove();
            }
        };

        window.moveRow = (btn, direction) => {
            const row = btn.closest('.tier-row');
            const board = document.getElementById('tier-board');
            if (direction === -1 && row.previousElementSibling) board.insertBefore(row, row.previousElementSibling);
            else if (direction === 1 && row.nextElementSibling) board.insertBefore(row.nextElementSibling, row);
        };

        function initBoard() {
            const board = document.getElementById('tier-board');
            board.innerHTML = '';
            defaultTiers.forEach(t => window.addTierRow(t.label, t.color));
        }

        // --- GITHUB IMAGES ---
        async function loadNinjasFromGitHub(pathIndex = 0) {
            const bank = document.getElementById('image-bank');
            const loader = document.getElementById('loading-indicator');
            const errorMsg = document.getElementById('error-message');
            
            if (pathIndex === 0) {
                loader.classList.remove('hidden');
                errorMsg.classList.add('hidden');
            }

            if (pathIndex >= PATHS_TO_TRY.length) {
                loader.classList.add('hidden');
                errorMsg.innerHTML = `Erro: Imagens não encontradas.`;
                errorMsg.classList.remove('hidden');
                return;
            }

            const path = PATHS_TO_TRY[pathIndex];
            const apiUrl = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${path}`;

            try {
                const response = await fetch(apiUrl);
                if (response.status === 404) {
                    await loadNinjasFromGitHub(pathIndex + 1);
                    return;
                }
                
                const files = await response.json();
                const imageFiles = files.filter(file => file.name.match(/\.(png|jpg|jpeg|gif)$/i));

                if (imageFiles.length === 0) {
                    await loadNinjasFromGitHub(pathIndex + 1);
                    return;
                }

                // Sucesso
                const pathPart = path ? `${path}/` : "";
                BASE_IMAGE_URL = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/${pathPart}`;

                imageFiles.forEach((file, index) => {
                    const ninjaName = file.name.replace(/\.[^/.]+$/, "");
                    
                    if(document.querySelector(`.draggable-item[data-name="${ninjaName}"]`)) return;

                    const div = document.createElement('div');
                    div.className = 'draggable-item'; 
                    
                    // Estrutura interna para imagem completa + nome embaixo
                    div.innerHTML = `
                        <div class="ninja-image" style="background-image: url('${file.download_url}')"></div>
                        <div class="ninja-name">${ninjaName}</div>
                    `;

                    div.draggable = true;
                    div.id = `ninja-${index}-${Date.now()}`; 
                    div.dataset.name = ninjaName; 

                    div.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData("text/plain", e.target.id);
                        e.target.style.opacity = '0.5';
                    });
                    div.addEventListener('dragend', (e) => e.target.style.opacity = '1');

                    bank.appendChild(div);
                });
                
                loader.classList.add('hidden');

            } catch (error) {
                console.error(`Erro ao ler ${path}:`, error);
                await loadNinjasFromGitHub(pathIndex + 1);
            }
        }

        // --- DRAG AND DROP ---
        window.allowDrop = (ev) => ev.preventDefault();
        window.drop = (ev) => {
            ev.preventDefault();
            const data = ev.dataTransfer.getData("text/plain");
            const draggedElement = document.getElementById(data);
            if(!draggedElement) return;

            let target = ev.target;
            // Se soltou em cima de outro item ou do nome/imagem dentro do item
            if (target.closest('.draggable-item')) {
                // Opção A: Adicionar ao pai (tier content)
                // target = target.closest('.tier-content') || target.closest('#image-bank');
                // Opção B: (Melhor) Só jogar no container pai do alvo
                target = target.closest('.draggable-item').parentElement;
            }

            if (target && (target.classList.contains('tier-content') || target.id === 'image-bank')) {
                target.appendChild(draggedElement);
            }
        };

        // --- SALVAR ---
        window.saveTierList = async () => {
            if (!currentUser) {
                alert("Conectando ao servidor...");
                return;
            }

            const title = document.getElementById('tier-title').value.trim();
            const creator = document.getElementById('creator-name').value.trim();

            if (!title) {
                alert("Por favor, preencha o Nome da Tier List.");
                document.getElementById('tier-title').focus();
                return;
            }
            if (!creator) {
                alert("Por favor, preencha o Seu Nick.");
                document.getElementById('creator-name').focus();
                return;
            }
            
            const rows = document.querySelectorAll('.tier-row');
            const tiersData = []; 

            rows.forEach(row => {
                const labelDiv = row.querySelector('.tier-label');
                const contentDiv = row.querySelector('.tier-content');
                const items = [];
                contentDiv.querySelectorAll('.draggable-item').forEach(item => items.push(item.dataset.name));
                
                tiersData.push({
                    label: labelDiv.innerText.trim(),
                    color: labelDiv.style.backgroundColor,
                    items: items
                });
            });

            try {
                await addDoc(collection(db, "tierlists"), {
                    title: title,
                    creatorName: creator, // Salva o nick digitado
                    tiers: tiersData, 
                    userId: currentUser.uid,
                    votes: 0,
                    voterIds: [], // Inicializa lista de votantes
                    createdAt: serverTimestamp(),
                    version: 2 
                });
                
                showToast("Salvo com sucesso!");
                document.getElementById('tier-title').value = "";
                // Não limpamos o Nick para facilitar criar outra
                
                // Reset
                const bank = document.getElementById('image-bank');
                document.querySelectorAll('.draggable-item').forEach(item => bank.appendChild(item));
                initBoard();

            } catch (e) {
                console.error("Erro: ", e);
                alert("Erro ao salvar: " + e.message);
            }
        };

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        // --- FEED COMUNIDADE ---
        const q = query(collection(db, "tierlists"), orderBy("votes", "desc")); 
        
        onSnapshot(q, (snapshot) => {
            const listContainer = document.getElementById('community-list');
            listContainer.innerHTML = "";

            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const id = docSnap.id;
                
                const card = document.createElement('div');
                card.className = "bg-gray-700 p-3 rounded border border-gray-600 hover:border-yellow-500 transition";
                
                let topTierItems = [];
                if (Array.isArray(data.tiers)) {
                    const firstNonEmpty = data.tiers.find(t => t.items && t.items.length > 0);
                    if (firstNonEmpty) topTierItems = firstNonEmpty.items;
                } else if (data.tiers && data.tiers.S) {
                    topTierItems = data.tiers.S;
                }

                let sPreview = "";
                if(topTierItems.length > 0) {
                     const top3 = topTierItems.slice(0, 3);
                     const baseUrl = BASE_IMAGE_URL || `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/imagens/ninja/`;
                     
                     sPreview = `<div class="flex gap-1 mb-2 mt-1">
                        ${top3.map(name => `<div class="w-8 h-8 rounded bg-cover border border-gray-800 bg-center" style="background-image: url('${baseUrl}${name}.png')"></div>`).join('')}
                        ${topTierItems.length > 3 ? '<span class="text-xs text-gray-400 self-end">...</span>' : ''}
                     </div>`;
                } else {
                    sPreview = `<div class="text-xs text-gray-500 italic mb-2">Vazio</div>`;
                }

                // Verifica se já votei (apenas visual)
                const alreadyVoted = data.voterIds && currentUser && data.voterIds.includes(currentUser.uid);
                const voteColor = alreadyVoted ? "text-green-500" : "text-gray-400 hover:text-yellow-500";

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-white text-lg leading-tight mb-1">${data.title}</h4>
                            <p class="text-xs text-gray-400">Criado por: <span class="text-yellow-500 font-bold">${data.creatorName || 'Anônimo'}</span></p>
                        </div>
                        <div class="flex flex-col items-center ml-2">
                            <button onclick="vote('${id}')" class="${voteColor} transition p-1" ${alreadyVoted ? 'disabled' : ''}>
                                <i class="fas fa-caret-up text-3xl"></i>
                            </button>
                            <span class="font-mono font-bold text-sm">${data.votes || 0}</span>
                        </div>
                    </div>
                    ${sPreview}
                `;
                listContainer.appendChild(card);
            });
        });

        window.vote = async (docId) => {
            if (!currentUser) {
                alert("Aguarde conectar...");
                return;
            }

            const docRef = doc(db, "tierlists", docId);
            
            try {
                // Verificação de segurança local (dupla checagem)
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.voterIds && data.voterIds.includes(currentUser.uid)) {
                        alert("Você já votou nesta lista!");
                        return;
                    }
                }

                // Atualiza adicionando o ID ao array e incrementando voto
                await updateDoc(docRef, { 
                    votes: increment(1),
                    voterIds: arrayUnion(currentUser.uid)
                });
                // O onSnapshot vai atualizar a cor do botão automaticamente
            } catch (e) {
                console.error("Erro ao votar:", e);
                // Se falhar (ex: regra de segurança), avisa
                if (e.code === 'permission-denied') {
                     alert("Erro: Você já votou ou não tem permissão.");
                }
            }
        };

        // INICIALIZAÇÃO
        initBoard();
        loadNinjasFromGitHub();

    </script>
</body>
</html>
